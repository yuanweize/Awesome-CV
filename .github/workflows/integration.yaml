name: CI

on:
  push:
    branches:
    - main
  pull_request: {}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # LaTeX Build - Uses template data to verify the code works
  # ---------------------------------------------------------------------------
  latex:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup for CI (use template data)
      run: |
        cp templates/config.tex.example config.tex
        cp templates/letter_config.tex.example letter_config.tex
        mkdir -p sections
        cp templates/sections/*.tex sections/
        echo "Using template data for CI build"

    - name: Compile Resume
      uses: xu-cheng/latex-action@v3
      with:
        root_file: src/main.tex
        latexmk_use_lualatex: true
      env:
        TEXINPUTS: "src/:.:"

    - name: Compile Cover Letter
      uses: xu-cheng/latex-action@v3
      with:
        root_file: src/coverletter.tex
        latexmk_use_lualatex: true
      env:
        TEXINPUTS: "src/:.:"

    - name: Rename outputs for release
      run: |
        mv src/main.pdf Awesome-CV_Example_Resume.pdf
        mv src/coverletter.pdf Awesome-CV_Example_Cover_Letter.pdf

    - name: Upload Resume PDF
      uses: actions/upload-artifact@v4
      with:
        name: resume-pdf
        path: Awesome-CV_Example_Resume.pdf

    - name: Upload Cover Letter PDF
      uses: actions/upload-artifact@v4
      with:
        name: coverletter-pdf
        path: Awesome-CV_Example_Cover_Letter.pdf

    - name: Get build date
      id: date
      run: echo "date=$(date -u +'%d %b %Y')" >> "$GITHUB_OUTPUT"

    - name: Update latest release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: "Build · ${{ steps.date.outputs.date }}"
        body: |
          Built from [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) on ${{ steps.date.outputs.date }} using **template data**.

          These example PDFs demonstrate the template layout — no real personal info included.
        files: |
          Awesome-CV_Example_Resume.pdf
          Awesome-CV_Example_Cover_Letter.pdf
        make_latest: true

  # ---------------------------------------------------------------------------
  # YAML Linting
  # ---------------------------------------------------------------------------
  yaml-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install yamllint
      run: pip install yamllint

    - name: Lint YAML files
      run: yamllint .
