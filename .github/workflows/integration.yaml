name: CI

on:
  push:
    branches:
    - main
  pull_request: {}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # LaTeX Build - Uses template data to verify the code works
  # ---------------------------------------------------------------------------
  latex:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup for CI (use template data)
      run: |
        cp config.tex.example config.tex
        cp letter_config.tex.example letter_config.tex
        mkdir -p sections
        cp sections_template/*.tex sections/
        echo "Using template data for CI build"

    - name: Compile Resume
      uses: xu-cheng/latex-action@v3
      with:
        root_file: main.tex
        latexmk_use_lualatex: true

    - name: Compile Cover Letter
      uses: xu-cheng/latex-action@v3
      with:
        root_file: coverletter.tex
        latexmk_use_lualatex: true

    - name: Rename outputs for release
      run: |
        mv main.pdf Awesome-CV_Example_Resume.pdf
        mv coverletter.pdf Awesome-CV_Example_Cover_Letter.pdf

    - name: Upload Resume PDF
      uses: actions/upload-artifact@v4
      with:
        name: resume-pdf
        path: Awesome-CV_Example_Resume.pdf

    - name: Upload Cover Letter PDF
      uses: actions/upload-artifact@v4
      with:
        name: coverletter-pdf
        path: Awesome-CV_Example_Cover_Letter.pdf

    - name: Update latest release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: "Build ${{ github.run_number }} â€” ${{ github.event.head_commit.timestamp }}"
        body: |
          Automatically built from `main` @ [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) using **template data** (not real personal info).

          These example PDFs demonstrate the template's layout and structure.
        files: |
          Awesome-CV_Example_Resume.pdf
          Awesome-CV_Example_Cover_Letter.pdf
        make_latest: true

  # ---------------------------------------------------------------------------
  # YAML Linting
  # ---------------------------------------------------------------------------
  yaml-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install yamllint
      run: pip install yamllint

    - name: Lint YAML files
      run: yamllint .
